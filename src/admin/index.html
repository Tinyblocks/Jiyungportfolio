<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Content Manager</title>
    <base href="/admin/">
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <div id="nc-root"></div>
    <script>
      // Use embedded config to force GitHub implicit auth (avoid any stale cached YAML)
      window.CMS_MANUAL_INIT = true;
      window.CMS_CONFIG = {
        backend: {
          name: 'github',
          repo: 'Tinyblocks/Jiyungportfolio',
          branch: 'main',
          auth_type: 'implicit',
          app_id: 'Ov23lirFziJiwYr1epSi'
        },
        media_folder: 'images',
        public_folder: '/images',
        publish_mode: 'simple',
        local_backend: false,
        collections: [
          {
            name: 'projects',
            label: 'Projects',
            folder: 'src/projects',
            create: true,
            slug: '{{slug}}',
            format: 'frontmatter',
            fields: [
              { label: 'Title', name: 'title', widget: 'string' },
              { label: 'Year', name: 'year', widget: 'number', value_type: 'int', min: 1900, max: 2100 },
              { label: 'Category', name: 'category', widget: 'select', options: ['personal', 'client', 'exhibition'], default: 'personal' },
              { label: 'Cover Image', name: 'cover', widget: 'image' },
              { label: 'Gallery Images', name: 'images', widget: 'list', field: { label: 'Image', name: 'image', widget: 'image' } },
              { label: 'Or gallery folder glob (e.g. /images/Seashells/*.{png,jpg})', name: 'imagesFolder', widget: 'string', required: false, hint: 'Use this to auto-include all images from a folder.' },
              { label: 'Description', name: 'body', widget: 'markdown' },
              { label: 'Layout', name: 'layout', widget: 'hidden', default: 'layouts/project.njk' },
              { label: 'Permalink', name: 'permalink', widget: 'hidden', default: '/projects/{{slug}}/index.html' }
            ]
          }
        ]
      };
    </script>
    <script id="decap-cms-script" src="/admin/decap-cms.js"></script>
    <script>
      (function(){
        function log(){ try{ console.log.apply(console, arguments); }catch(_){} }
        function logErr(){ try{ console.error.apply(console, arguments); }catch(_){} }
        var initialized = false;
        function maybeInitCMS(){
          if (initialized) return;
          try {
            if (window.CMS && typeof window.CMS.init === 'function') {
              if (window.CMS_CONFIG) {
                window.CMS.init({ config: window.CMS_CONFIG });
              } else {
                window.CMS.init();
              }
              initialized = true;
              log('[admin] CMS.init() ok');
            }
          } catch(err) { logErr('[admin] CMS.init error', err); }
          try {
            if (!location.hash || location.hash === '#/') {
              location.hash = '#/collections/projects';
            }
          } catch(err) { logErr('[admin] nav hash error', err); }
        }
        function onReady(){
          // purge any stale Netlify Identity / Git Gateway state so GitHub implicit auth is used
          try {
            var keys = Object.keys(localStorage || {});
            for (var i = 0; i < keys.length; i++) {
              var k = keys[i];
              if (k.indexOf('netlify') === 0 || k.indexOf('gotrue') === 0 || k === 'netlify-cms-user' || k.indexOf('nf_') === 0) {
                try { localStorage.removeItem(k); } catch(_) {}
              }
            }
          } catch(_) {}
          try { if (sessionStorage) sessionStorage.clear(); } catch(_) {}
          // ensure script loaded
          var s = document.getElementById('decap-cms-script');
          if (!s) logErr('[admin] decap-cms script tag missing');
          maybeInitCMS();
          setTimeout(maybeInitCMS, 0);
          setTimeout(maybeInitCMS, 300);
        }
        window.addEventListener('error', function(e){ logErr('Admin runtime error:', e.error || e.message || e); });
        window.addEventListener('unhandledrejection', function(e){ logErr('Admin unhandledrejection:', e.reason || e); });
        if (document.readyState === 'complete' || document.readyState === 'interactive') onReady();
        else document.addEventListener('DOMContentLoaded', onReady);
      })();
    </script>
  </body>
  </html>
